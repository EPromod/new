<!DOCTYPE html>
<html lang="id" data-theme="light">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Life Organizer Pro</title>
  
  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">

  <style>
    :root {
      /* Palette Modern */
      --primary: #4f46e5; /* Indigo */
      --primary-glow: rgba(79, 70, 229, 0.4);
      --secondary: #ec4899; /* Pink */
      --bg-body: #f3f4f6;
      --bg-glass: rgba(255, 255, 255, 0.85);
      --bg-sidebar: #ffffff;
      --text-main: #1f2937;
      --text-muted: #6b7280;
      --border-color: rgba(255, 255, 255, 0.6);
      --card-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.05);
      --sidebar-width: 260px;
      --radius: 20px;
    }

    [data-theme="dark"] {
      --primary: #6366f1;
      --primary-glow: rgba(99, 102, 241, 0.3);
      --secondary: #f472b6;
      --bg-body: #0f172a;
      --bg-glass: rgba(30, 41, 59, 0.7);
      --bg-sidebar: #1e293b;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --border-color: rgba(255, 255, 255, 0.05);
      --card-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.3);
    }

    * { box-sizing: border-box; outline: none; }

    body {
      margin: 0;
      font-family: 'Outfit', sans-serif;
      background-color: var(--bg-body);
      /* Background Abstract Decoration */
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
      background-size: cover;
      background-attachment: fixed;
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    [data-theme="light"] body {
      background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,93%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,90%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,90%,1) 0, transparent 50%);
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: var(--sidebar-width);
      background: var(--bg-sidebar);
      padding: 2rem 1.5rem;
      display: flex;
      flex-direction: column;
      border-right: 1px solid var(--border-color);
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 3rem;
    }

    .brand i { font-size: 1.8rem; }

    .menu-list {
      list-style: none;
      padding: 0;
      margin: 0;
      flex: 1;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 14px 18px;
      border-radius: 14px;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
      margin-bottom: 8px;
    }

    .menu-item:hover, .menu-item.active {
      background: var(--primary);
      color: #fff;
      box-shadow: 0 8px 20px var(--primary-glow);
    }
    
    .menu-item i { width: 20px; text-align: center; }

    .user-profile {
      padding-top: 20px;
      border-top: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex; align-items: center; justify-content: center;
      color: white; font-weight: bold;
    }

    /* --- MAIN CONTENT --- */
    .main-wrapper {
      flex: 1;
      position: relative;
      overflow-y: auto;
      scroll-behavior: smooth;
      padding: 2rem;
    }

    /* Header Bar */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .welcome-text h1 { margin: 0; font-size: 1.8rem; }
    .welcome-text p { margin: 5px 0 0; color: var(--text-muted); font-size: 0.9rem; }

    .top-actions { display: flex; gap: 15px; }

    .btn-icon {
      width: 45px; height: 45px;
      border-radius: 12px;
      border: 1px solid var(--border-color);
      background: var(--bg-glass);
      color: var(--text-main);
      display: flex; align-items: center; justify-content: center;
      cursor: pointer;
      transition: transform 0.2s;
      font-size: 1.1rem;
    }

    .btn-icon:hover { transform: translateY(-2px); background: var(--primary); color: white; }

    /* AI Input Area */
    .ai-input-container {
      background: var(--bg-glass);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      padding: 1.5rem;
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      margin-bottom: 2rem;
      border: 1px solid var(--border-color);
      display: flex;
      gap: 15px;
      align-items: center;
    }

    #userInput {
      flex: 1;
      border: none;
      background: transparent;
      font-size: 1rem;
      color: var(--text-main);
      font-family: 'Outfit', sans-serif;
    }

    #userInput::placeholder { color: var(--text-muted); }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 4px 15px var(--primary-glow);
      transition: 0.3s;
      display: flex; align-items: center; gap: 8px;
    }
    
    .btn-primary:hover { opacity: 0.9; transform: scale(1.02); }

    /* Stats Widgets */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: var(--bg-glass);
      padding: 1.5rem;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card h3 { margin: 0; font-size: 2rem; color: var(--primary); }
    .stat-card span { color: var(--text-muted); font-size: 0.9rem; }
    .stat-icon {
      position: absolute; right: 15px; top: 15px;
      font-size: 2.5rem; opacity: 0.1; color: var(--text-main);
    }

    /* Grid Layout for Content */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr 350px;
      grid-template-rows: auto auto;
      gap: 25px;
    }

    @media (max-width: 1200px) {
      .dashboard-grid { grid-template-columns: 1fr 1fr; }
      #remindersSection, #notesSection { grid-column: auto; }
    }
    @media (max-width: 900px) {
      .sidebar { position: fixed; left: -100%; height: 100%; box-shadow: 5px 0 15px rgba(0,0,0,0.1); }
      .sidebar.active { left: 0; }
      .dashboard-grid { grid-template-columns: 1fr; }
    }

    #todoSection { grid-column: 1 / span 1; grid-row: 1 / span 2; }
    #calendarSection { grid-column: 2 / span 1; grid-row: 1 / span 2; }
    
    /* Section Styling */
    .section {
      background: var(--bg-glass);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      min-height: 350px;
      box-shadow: var(--card-shadow);
      transition: transform 0.3s ease;
    }

    .section:hover { transform: translateY(-3px); }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }

    .section-header h2 { margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
    .section-header button {
      background: transparent;
      border: 1px solid var(--border-color);
      color: var(--primary);
      width: 30px; height: 30px; border-radius: 8px;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }
    .section-header button:hover { background: var(--primary); color: white; }

    /* Items Styling */
    .todo-item, .reminder-item, .note-item, .file-item {
      background: rgba(255, 255, 255, 0.05);
      border-bottom: 1px solid var(--border-color);
      padding: 12px;
      margin-bottom: 8px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      transition: 0.2s;
    }

    .todo-item:hover, .reminder-item:hover { background: rgba(var(--primary), 0.05); padding-left: 15px; }
    
    input[type="text"], textarea {
      background: transparent; border: none; color: var(--text-main); font-family: inherit; width: 100%;
    }
    
    .delete-btn {
      background: transparent; border: none; color: #ef4444; opacity: 0.5; cursor: pointer;
    }
    .delete-btn:hover { opacity: 1; }

    /* Calendar Overrides */
    .fc { --fc-border-color: var(--border-color); --fc-text-color: var(--text-main); }
    .fc-toolbar-title { font-size: 1.2rem !important; }
    .fc-button { background: var(--primary) !important; border: none !important; border-radius: 8px !important; }

    /* Chat Panel Floating */
    .chat-panel {
      position: fixed;
      right: -400px;
      top: 0; bottom: 0;
      width: 380px;
      background: var(--bg-sidebar);
      box-shadow: -10px 0 40px rgba(0,0,0,0.2);
      z-index: 1000;
      transition: right 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      display: flex; flex-direction: column;
    }
    .chat-panel.open { right: 0; }
    
    .chat-header {
      padding: 20px;
      background: var(--primary);
      color: white;
      display: flex; justify-content: space-between; align-items: center;
    }
    
    .chat-messages { flex: 1; padding: 20px; overflow-y: auto; background: var(--bg-body); }
    .message { padding: 12px 16px; border-radius: 12px; margin-bottom: 10px; font-size: 0.9rem; max-width: 85%; }
    .message.user { background: var(--primary); color: white; margin-left: auto; border-radius: 12px 12px 0 12px; }
    .message.ai { background: white; color: black; border: 1px solid #eee; margin-right: auto; border-radius: 12px 12px 12px 0; }
    [data-theme="dark"] .message.ai { background: #334155; color: white; border: none; }

    /* Modal */
    .modal-overlay {
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      z-index: 2000;
    }
    .modal {
      background: var(--bg-sidebar);
      color: var(--text-main);
      border: 1px solid var(--border-color);
    }
    .modal input { border: 1px solid var(--border-color); padding: 12px; border-radius: 8px; color: var(--text-main); }

    /* Typing Dots */
    .typing-indicator { display: none; gap: 4px; margin-left: 10px; }
    .dot { width: 6px; height: 6px; background: var(--primary); border-radius: 50%; animation: bounce 1s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

  </style>
</head>
<body>

  <!-- Sidebar Menu -->
  <nav class="sidebar" id="sidebar">
    <div class="brand">
      <i class="fa-solid fa-brain"></i>
      <span>AI Organizer</span>
    </div>
    <ul class="menu-list">
      <li class="menu-item active" onclick="scrollToSection('top')">
        <i class="fa-solid fa-grip"></i> Dashboard
      </li>
      <li class="menu-item" onclick="scrollToSection('todoSection')">
        <i class="fa-solid fa-check-circle"></i> Tasks
      </li>
      <li class="menu-item" onclick="scrollToSection('calendarSection')">
        <i class="fa-solid fa-calendar-alt"></i> Calendar
      </li>
      <li class="menu-item" onclick="scrollToSection('remindersSection')">
        <i class="fa-solid fa-bell"></i> Reminders
      </li>
      <li class="menu-item" onclick="scrollToSection('notesSection')">
        <i class="fa-solid fa-sticky-note"></i> Notes
      </li>
      <li class="menu-item" onclick="scrollToSection('fileSection')">
        <i class="fa-solid fa-folder"></i> Files
      </li>
    </ul>
    
    <div class="user-profile">
      <div class="avatar">U</div>
      <div style="font-size: 0.9rem;">
        <div style="font-weight: 600;">User</div>
        <div style="font-size: 0.8rem; opacity: 0.7;">Pro Plan</div>
      </div>
      <i class="fa-solid fa-gear" onclick="openSettings()" style="margin-left: auto; cursor: pointer; opacity: 0.7;"></i>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="main-wrapper">
    
    <!-- Top Bar -->
    <div class="top-bar">
      <div class="welcome-text">
        <h1 id="greeting">Hello, Organizer!</h1>
        <p>Let's plan your success today.</p>
      </div>
      <div class="top-actions">
        <button class="btn-icon" onclick="toggleTheme()" title="Toggle Theme">
          <i class="fa-solid fa-moon"></i>
        </button>
        <button class="btn-icon" onclick="toggleChat()" title="Chat Assistant">
          <i class="fa-solid fa-message"></i>
        </button>
        <button class="btn-icon d-lg-none" onclick="toggleSidebar()" style="display: none;"> <!-- Mobile trigger -->
          <i class="fa-solid fa-bars"></i>
        </button>
      </div>
    </div>

    <!-- Quick Stats Widget -->
    <div class="stats-grid">
      <div class="stat-card">
        <h3 id="taskCount">0</h3>
        <span>Pending Tasks</span>
        <i class="fa-solid fa-list-check stat-icon"></i>
      </div>
      <div class="stat-card">
        <h3 id="eventCount">0</h3>
        <span>Upcoming Events</span>
        <i class="fa-solid fa-calendar-day stat-icon"></i>
      </div>
      <div class="stat-card">
        <h3 id="noteCount">0</h3>
        <span>Active Notes</span>
        <i class="fa-solid fa-note-sticky stat-icon"></i>
      </div>
    </div>

    <!-- AI Input -->
    <div class="ai-input-container">
      <i class="fa-solid fa-wand-magic-sparkles" style="color: var(--secondary); font-size: 1.2rem;"></i>
      <input type="text" id="userInput" placeholder="Ask AI to plan your day... (e.g. 'Plan a workout schedule for next week')">
      <div class="typing-indicator" id="typingIndicatorMain">
        <div class="dot"></div><div class="dot"></div><div class="dot"></div>
      </div>
      <button class="btn-primary" id="submitButton">
        Generate <i class="fa-solid fa-arrow-right"></i>
      </button>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
      
      <!-- Todo Section -->
      <div class="section" id="todoSection">
        <div class="section-header">
          <h2><i class="fa-solid fa-check-double" style="color: #10b981;"></i> My Tasks</h2>
          <button onclick="addTodo('')"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div id="todoList" style="overflow-y: auto; flex: 1;"></div>
      </div>

      <!-- Calendar Section -->
      <div class="section" id="calendarSection">
        <div class="section-header">
          <h2><i class="fa-solid fa-calendar" style="color: #6366f1;"></i> Schedule</h2>
        </div>
        <div id="calendar" style="flex: 1;"></div>
      </div>

      <!-- Reminders Section -->
      <div class="section" id="remindersSection">
        <div class="section-header">
          <h2><i class="fa-solid fa-clock" style="color: #f59e0b;"></i> Reminders</h2>
          <button onclick="addReminder('')"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div id="remindersList" style="overflow-y: auto; flex: 1;"></div>
      </div>

      <!-- Notes Section -->
      <div class="section" id="notesSection">
        <div class="section-header">
          <h2><i class="fa-solid fa-pen-nib" style="color: #ec4899;"></i> Notes</h2>
          <button onclick="addNote('')"><i class="fa-solid fa-plus"></i></button>
        </div>
        <div id="notesList" style="overflow-y: auto; flex: 1;"></div>
      </div>

      <!-- Files Section -->
      <div class="section" id="fileSection" style="grid-column: 1 / -1;">
        <div class="section-header">
          <h2><i class="fa-solid fa-folder-open" style="color: #3b82f6;"></i> Files Manager</h2>
          <button onclick="uploadFile()"><i class="fa-solid fa-upload"></i></button>
        </div>
        <div id="fileList" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;"></div>
      </div>

    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal-overlay" style="display: none; position: fixed; top:0; left:0; width:100%; height:100%; align-items:center; justify-content:center;">
    <div class="modal" style="padding: 2rem; border-radius: 15px; width: 90%; max-width: 450px;">
      <h2 style="margin-top:0;">API Settings</h2>
      <p style="color: var(--text-muted);">Enter Google Gemini API Key to activate AI.</p>
      <input type="password" id="apiKeyInput" placeholder="Paste Gemini API Key here..." style="width:100%; margin: 10px 0 20px;">
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="closeSettings()" style="background: transparent; border: 1px solid var(--border-color); color: var(--text-main); padding: 8px 16px; border-radius: 8px;">Cancel</button>
        <button onclick="saveApiKey()" class="btn-primary">Save Key</button>
      </div>
    </div>
  </div>

  <!-- Chat Panel -->
  <div class="chat-panel" id="chatPanel">
    <div class="chat-header">
      <span style="font-weight: 600;"><i class="fa-solid fa-robot"></i> Gemini Assistant</span>
      <i class="fa-solid fa-xmark" onclick="toggleChat()" style="cursor: pointer;"></i>
    </div>
    <div class="chat-messages" id="chatMessages">
      <div class="message ai">Hi! I'm ready to organize your life. Configure the API Key first.</div>
    </div>
    <div style="padding: 15px; background: var(--bg-sidebar); border-top: 1px solid var(--border-color); display: flex; gap: 10px;">
      <input type="text" id="chatInput" placeholder="Type here..." style="flex: 1; padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-body);">
      <button onclick="sendChatMessage()" class="btn-primary" style="padding: 0 15px;"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
  </div>

  <!-- Scripts -->
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
  <script>
    // --- Logic Intact (Same functionality, updated ID references) ---
    
    let calendar;
    let todos = [];
    let reminders = [];
    let notes = [];
    let files = [];
    let geminiApiKey = localStorage.getItem('gemini_api_key') || '';

    // Greeting based on time
    const hour = new Date().getHours();
    const greet = hour < 12 ? 'Good Morning' : hour < 18 ? 'Good Afternoon' : 'Good Evening';
    document.getElementById('greeting').innerText = `${greet}, Organizer!`;

    document.addEventListener('DOMContentLoaded', function() {
      initCalendar();
      setupEventHandlers();
      loadData();
      addDefaultItems();
      loadFiles();
      updateStats();
      
      if (!geminiApiKey) setTimeout(openSettings, 1000);
    });

    function updateStats() {
      document.getElementById('taskCount').innerText = todos.filter(t => !t.completed).length;
      document.getElementById('noteCount').innerText = notes.length;
      if(calendar) document.getElementById('eventCount').innerText = calendar.getEvents().length;
    }

    function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek'
        },
        height: '100%',
        editable: true,
        selectable: true,
        events: [],
        select: function(info) {
          const title = prompt('Enter event title:');
          if (title) {
            calendar.addEvent({ title: title, start: info.start, end: info.end, allDay: info.allDay });
            saveData();
          }
          calendar.unselect();
        },
        eventClick: function(info) {
          if (confirm('Delete this event?')) {
            info.event.remove();
            saveData();
          }
        },
        eventDrop: saveData,
        eventResize: saveData
      });
      calendar.render();
    }

    function setupEventHandlers() {
      document.getElementById('submitButton').addEventListener('click', handleAIRequest);
      document.getElementById('userInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') handleAIRequest();
      });
      document.getElementById('chatInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') sendChatMessage();
      });
    }

    // UI Functions
    function scrollToSection(id) {
      if(id === 'top') {
        document.querySelector('.main-wrapper').scrollTo(0,0);
      } else {
        const el = document.getElementById(id);
        if(el) el.scrollIntoView({ behavior: 'smooth' });
      }
      // Update active menu
      document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
      event.currentTarget.classList.add('active');
    }

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      const icon = document.querySelector('.top-actions .fa-moon');
      if(next === 'dark') { icon.classList.remove('fa-moon'); icon.classList.add('fa-sun'); }
      else { icon.classList.remove('fa-sun'); icon.classList.add('fa-moon'); }
    }

    function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; document.getElementById('apiKeyInput').value = geminiApiKey; }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function saveApiKey() {
      geminiApiKey = document.getElementById('apiKeyInput').value.trim();
      localStorage.setItem('gemini_api_key', geminiApiKey);
      closeSettings();
    }
    function toggleChat() { document.getElementById('chatPanel').classList.toggle('open'); }

    // --- AI Logic ---
    async function callGemini(promptText) {
      if (!geminiApiKey) throw new Error("API Key missing.");
      const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${geminiApiKey}`;
      const payload = { contents: [{ parts: [{ text: promptText }] }] };
      const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
      if (!response.ok) throw new Error("Gemini API Error");
      const data = await response.json();
      return data.candidates[0].content.parts[0].text;
    }

    function cleanJSON(text) {
      let clean = text.replace(/```json/g, '').replace(/```/g, '').trim();
      const start = clean.indexOf('{');
      const end = clean.lastIndexOf('}');
      return (start !== -1 && end !== -1) ? clean.substring(start, end + 1) : clean;
    }

    async function handleAIRequest() {
      const userInput = document.getElementById('userInput');
      const indicator = document.getElementById('typingIndicatorMain');
      if (!userInput.value.trim()) return;
      if (!geminiApiKey) { openSettings(); return; }

      indicator.style.display = 'flex';
      const systemPrompt = `You are an AI Organizer. User request: "${userInput.value}". Return ONLY JSON: {"todos": [], "events": [{"title":"", "start":"YYYY-MM-DD"}], "reminders": [], "notes": [], "message": ""}. Current Date: ${new Date().toISOString()}.`;

      try {
        const raw = await callGemini(systemPrompt);
        const data = JSON.parse(cleanJSON(raw));
        processAIResponse(data);
        userInput.value = '';
      } catch (e) { alert(e.message); }
      indicator.style.display = 'none';
    }

    function processAIResponse(response) {
      if (response.todos) response.todos.forEach(t => addTodo(t));
      if (response.reminders) response.reminders.forEach(r => addReminder(r));
      if (response.notes) response.notes.forEach(n => addNote(n));
      if (response.events && calendar) response.events.forEach(e => calendar.addEvent(e));
      if (response.message) {
        document.getElementById('chatMessages').innerHTML += `<div class="message ai">${response.message}</div>`;
        toggleChat();
      }
      saveData();
    }

    async function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const msgs = document.getElementById('chatMessages');
      const txt = input.value.trim();
      if(!txt) return;
      
      msgs.innerHTML += `<div class="message user">${txt}</div>`;
      input.value = '';
      
      const context = { todos: todos, notes: notes };
      const prompt = `User: ${txt}. Context: ${JSON.stringify(context)}. Reply with helpful short text or JSON with "message" field.`;
      
      try {
        const raw = await callGemini(prompt);
        let msg = raw;
        try { const json = JSON.parse(cleanJSON(raw)); msg = json.message || raw; if(json.todos) processAIResponse(json); } catch(e){}
        msgs.innerHTML += `<div class="message ai">${msg}</div>`;
        msgs.scrollTop = msgs.scrollHeight;
      } catch(e) { msgs.innerHTML += `<div class="message ai" style="color:red">Error.</div>`; }
    }

    // --- CRUD ---
    function addTodo(text) { todos.push({ id: Date.now(), text: text || 'New Task', completed: false }); renderTodos(); saveData(); }
    function renderTodos() {
      document.getElementById('todoList').innerHTML = todos.map(t => `
        <div class="todo-item">
          <input type="checkbox" ${t.completed ? 'checked' : ''} onchange="toggleTodo(${t.id})">
          <input type="text" value="${t.text}" onchange="updateTodo(${t.id}, this.value)" style="text-decoration: ${t.completed ? 'line-through': 'none'}; opacity: ${t.completed?0.5:1}">
          <button class="delete-btn" onclick="deleteTodo(${t.id})"><i class="fa-solid fa-trash"></i></button>
        </div>`).join('');
        updateStats();
    }
    function toggleTodo(id) { const t = todos.find(x => x.id == id); if(t) t.completed = !t.completed; renderTodos(); saveData(); }
    function updateTodo(id, txt) { const t = todos.find(x => x.id == id); if(t) t.text = txt; saveData(); }
    function deleteTodo(id) { todos = todos.filter(t => t.id != id); renderTodos(); saveData(); }

    function addReminder(text) { reminders.push({ id: Date.now(), text: text || 'New Reminder' }); renderReminders(); saveData(); }
    function renderReminders() {
      document.getElementById('remindersList').innerHTML = reminders.map(r => `
        <div class="reminder-item">
          <i class="fa-regular fa-bell" style="margin-right:8px; color:var(--secondary)"></i>
          <input type="text" value="${r.text}" onchange="updateReminder(${r.id}, this.value)">
          <button class="delete-btn" onclick="deleteReminder(${r.id})"><i class="fa-solid fa-times"></i></button>
        </div>`).join('');
    }
    function updateReminder(id, txt) { const r = reminders.find(x => x.id == id); if(r) r.text = txt; saveData(); }
    function deleteReminder(id) { reminders = reminders.filter(r => r.id != id); renderReminders(); saveData(); }

    function addNote(text) { notes.push({ id: Date.now(), text: text || 'New Note' }); renderNotes(); saveData(); }
    function renderNotes() {
      document.getElementById('notesList').innerHTML = notes.map(n => `
        <div class="note-item" style="flex-direction:column; align-items:flex-start;">
          <textarea onchange="updateNote(${n.id}, this.value)" style="resize:vertical; min-height:60px;">${n.text}</textarea>
          <button class="delete-btn" onclick="deleteNote(${n.id})" style="align-self:flex-end; margin-top:5px;"><i class="fa-solid fa-trash"></i></button>
        </div>`).join('');
        updateStats();
    }
    function updateNote(id, txt) { const n = notes.find(x => x.id == id); if(n) n.text = txt; saveData(); }
    function deleteNote(id) { notes = notes.filter(n => n.id != id); renderNotes(); saveData(); }

    function uploadFile() {
      const input = document.createElement('input'); input.type = 'file';
      input.onchange = e => { files.push({ name: e.target.files[0].name }); renderFiles(); saveData(); };
      input.click();
    }
    function renderFiles() {
      document.getElementById('fileList').innerHTML = files.map(f => `
        <div class="file-item" style="flex-direction: column; text-align: center; justify-content: center; height: 100px;">
          <i class="fa-solid fa-file-lines" style="font-size: 2rem; color: var(--text-muted); margin-bottom: 10px;"></i>
          <div style="font-size: 0.8rem; overflow: hidden; text-overflow: ellipsis; width: 100%;">${f.name}</div>
        </div>`).join('');
    }
    function loadFiles() { files = JSON.parse(localStorage.getItem('files')) || []; renderFiles(); }

    function saveData() {
      localStorage.setItem('todos', JSON.stringify(todos));
      localStorage.setItem('reminders', JSON.stringify(reminders));
      localStorage.setItem('notes', JSON.stringify(notes));
      localStorage.setItem('files', JSON.stringify(files));
      const events = calendar.getEvents().map(e => ({ title: e.title, start: e.start, end: e.end, allDay: e.allDay }));
      localStorage.setItem('events', JSON.stringify(events));
      updateStats();
    }

    function loadData() {
      todos = JSON.parse(localStorage.getItem('todos')) || [];
      reminders = JSON.parse(localStorage.getItem('reminders')) || [];
      notes = JSON.parse(localStorage.getItem('notes')) || [];
      const events = JSON.parse(localStorage.getItem('events')) || [];
      renderTodos(); renderReminders(); renderNotes();
      events.forEach(e => calendar.addEvent(e));
    }

    function addDefaultItems() {
      if (todos.length === 0) addTodo('Add your API Key in Settings');
    }
  </script>
</body>
</html>