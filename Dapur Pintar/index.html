<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inventaris Dapur & Resep AI</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4CAF50">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3565/3565418.png">

    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'primary': '#4CAF50', 'secondary': '#FFC107', 'card': '#FFFFFF' }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f3f4f6; }
        .scroll-area { max-height: 40vh; overflow-y: auto; }
        .scroll-area::-webkit-scrollbar { width: 6px; }
        .scroll-area::-webkit-scrollbar-thumb { background-color: #A5D6A7; border-radius: 3px; }
        /* Tombol Install */
        #install-btn { display: none; }
        /* Badge Offline */
        .offline-badge { display: none; background: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        /* Modal Background */
        #api-modal { background-color: rgba(0, 0, 0, 0.5); backdrop-filter: blur(2px); }
    </style>
</head>
<body class="font-sans antialiased text-gray-800 relative">

    <div id="app" class="min-h-screen p-4 flex flex-col items-center max-w-lg mx-auto relative">
        
        <!-- Tombol Pengaturan API (Pojok Kanan Atas) -->
        <button onclick="openApiModal()" class="absolute top-4 right-4 text-gray-400 hover:text-primary transition p-2" title="Atur API Key">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        </button>

        <!-- Header -->
        <header class="w-full mb-6 text-center mt-2">
            <div class="flex justify-center items-center gap-2 mb-2">
                <h1 class="text-2xl font-bold text-primary">Dapur Pintar</h1>
                <span id="offline-indicator" class="offline-badge">OFFLINE</span>
            </div>
            <p class="text-sm text-gray-500">Kelola inventaris offline, cari resep online.</p>
            
            <!-- Tombol Install PWA -->
            <button id="install-btn" class="mt-3 bg-gray-800 text-white text-xs px-4 py-2 rounded-full shadow-lg hover:bg-gray-700 transition animate-bounce">
                ‚¨á Install Aplikasi
            </button>
        </header>

        <!-- Main Content Area (Inventory Management) -->
        <div class="w-full bg-card shadow-xl rounded-xl p-5 mb-6 border border-gray-100">
            <h2 class="text-lg font-semibold mb-4 border-b pb-2 text-primary flex items-center gap-2">
                üì¶ Daftar Bahan (Tersimpan Lokal)
            </h2>

            <form id="add-ingredient-form" class="flex flex-col sm:flex-row gap-2 mb-4">
                <input type="text" id="ingredient-name" placeholder="Nama Bahan" required class="flex-grow p-2 border rounded focus:outline-none focus:ring-2 focus:ring-primary">
                <div class="flex gap-2">
                    <input type="number" id="ingredient-qty" value="1" min="1" required class="w-16 p-2 border rounded text-center">
                    <select id="ingredient-unit" class="p-2 border rounded w-20">
                        <option value="pcs">Pcs</option>
                        <option value="kg">Kg</option>
                        <option value="gr">Gr</option>
                        <option value="ltr">L</option>
                    </select>
                </div>
                <button type="submit" class="bg-primary hover:bg-green-600 text-white font-bold py-2 px-4 rounded shadow">
                    +
                </button>
            </form>

            <div class="scroll-area bg-gray-50 rounded-lg p-2 border border-gray-200 min-h-[100px]">
                <div id="ingredient-list" class="space-y-2">
                    <p class="text-center text-gray-400 text-sm mt-4">Inventaris kosong.</p>
                </div>
            </div>
        </div>

        <!-- Recipe Suggestion Section -->
        <div class="w-full bg-card shadow-xl rounded-xl p-5 border border-gray-100">
            <h2 class="text-lg font-semibold mb-4 border-b pb-2 text-primary flex items-center gap-2">
                üç≥ Cari Resep (Butuh Internet)
            </h2>

            <button id="suggest-recipe-btn" class="w-full bg-secondary hover:bg-yellow-500 text-gray-900 font-bold py-3 px-4 rounded-lg shadow-md flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed transition">
                <span>‚ú® Saran Resep AI</span>
            </button>
            <p id="offline-msg" class="text-red-500 text-xs text-center mt-2 hidden">Mode Offline: Fitur AI tidak tersedia.</p>
            <p id="suggestion-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>

            <div id="loading-spinner" class="mt-4 text-center hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-gray-200 border-t-primary"></div>
                <p class="text-xs text-gray-500 mt-2">Sedang meracik resep...</p>
            </div>

            <div id="recipe-output" class="mt-5 p-4 bg-green-50 border border-green-100 rounded-lg hidden">
                <!-- Header Hasil Resep + Tombol Download -->
                <div class="flex justify-between items-start mb-2 border-b border-green-200 pb-2">
                    <h3 class="font-bold text-primary">Hasil Resep:</h3>
                    <button id="download-recipe-btn" class="text-xs bg-white border border-green-300 text-green-700 hover:bg-green-100 px-3 py-1 rounded shadow-sm flex items-center gap-1 transition" title="Simpan sebagai file teks">
                        üì• Simpan Teks
                    </button>
                </div>
                <!-- Isi Resep -->
                <div id="recipe-text" class="prose prose-sm max-w-none text-gray-700 text-sm"></div>
            </div>
        </div>

    </div>

    <!-- MODAL POPUP API KEY -->
    <div id="api-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden px-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-bold text-gray-800">Pengaturan API Gemini</h3>
                <button onclick="closeApiModal()" class="text-gray-400 hover:text-red-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <p class="text-sm text-gray-600 mb-4">
                Masukkan API Key Gemini Google Anda agar fitur "Saran Resep" dapat berfungsi. Key disimpan di browser Anda.
            </p>
            
            <div class="mb-4">
                <label for="api-key-input" class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                <input type="password" id="api-key-input" class="w-full p-2 border border-gray-300 rounded focus:ring-primary focus:border-primary focus:outline-none" placeholder="Tempel kunci AIza... di sini">
            </div>

            <div class="flex justify-end gap-2">
                <button onclick="closeApiModal()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded font-medium">Batal</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-primary text-white rounded font-bold hover:bg-green-600 shadow">Simpan</button>
            </div>
            
            <div class="mt-4 text-xs text-gray-400 text-center">
                Belum punya? <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-primary hover:underline">Dapatkan API Key Gratis</a>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION & API KEY MANAGEMENT ---
        const INVENTORY_KEY = "offline_dapur_v1";
        const API_STORAGE_KEY = "dapur_pintar_api_key";
        
        // Ambil Key dari LocalStorage saat load
        let geminiApiKey = localStorage.getItem(API_STORAGE_KEY) || "";

        // Fungsi Modal API
        const apiModal = document.getElementById('api-modal');
        const apiKeyInput = document.getElementById('api-key-input');

        function openApiModal() {
            apiKeyInput.value = geminiApiKey; // Isi input dengan key yang tersimpan
            apiModal.classList.remove('hidden');
        }

        function closeApiModal() {
            apiModal.classList.add('hidden');
        }

        function saveApiKey() {
            const newKey = apiKeyInput.value.trim();
            if (!newKey) {
                alert("Silakan masukkan API Key yang valid.");
                return;
            }
            geminiApiKey = newKey;
            localStorage.setItem(API_STORAGE_KEY, geminiApiKey);
            closeApiModal();
            alert("API Key berhasil disimpan!");
            
            // Hapus pesan error jika ada
            document.getElementById('suggestion-error').classList.add('hidden');
        }

        // --- 2. PWA INSTALLATION & SERVICE WORKER ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Pastikan file sw.js ada di root directory
                navigator.serviceWorker.register('./sw.js')
                    .then(() => console.log('Service Worker OK'))
                    .catch(err => console.error('SW Fail', err));
            });
        }

        let deferredPrompt;
        const installBtn = document.getElementById('install-btn');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installBtn.style.display = 'inline-block';
        });

        installBtn.addEventListener('click', () => {
            installBtn.style.display = 'none';
            deferredPrompt.prompt();
            deferredPrompt.userChoice.then((result) => {
                deferredPrompt = null;
            });
        });

        // --- 3. ONLINE/OFFLINE DETECTION ---
        const offlineBadge = document.getElementById('offline-indicator');
        const recipeBtn = document.getElementById('suggest-recipe-btn');
        const offlineMsg = document.getElementById('offline-msg');

        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineBadge.style.display = 'none';
                recipeBtn.disabled = false;
                offlineMsg.classList.add('hidden');
                recipeBtn.innerHTML = '<span>‚ú® Saran Resep AI</span>';
            } else {
                offlineBadge.style.display = 'inline-block';
                recipeBtn.disabled = true;
                offlineMsg.classList.remove('hidden');
                recipeBtn.innerHTML = '<span>üì° Tidak Ada Internet</span>';
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus(); // Cek saat load awal

        // --- 4. INVENTORY LOGIC (OFFLINE CAPABLE) ---
        let inventory = JSON.parse(localStorage.getItem(INVENTORY_KEY)) || [];

        function renderInventory() {
            const list = document.getElementById('ingredient-list');
            list.innerHTML = '';
            
            if (inventory.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 text-sm py-4">Belum ada bahan.</p>';
                return;
            }

            inventory.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center bg-white p-2 rounded shadow-sm border border-gray-100';
                div.innerHTML = `
                    <div>
                        <span class="font-medium capitalize">${item.name}</span>
                        <span class="text-xs text-gray-500 block">${item.qty} ${item.unit}</span>
                    </div>
                    <button onclick="deleteItem(${index})" class="text-red-500 hover:bg-red-50 p-1 rounded">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                list.appendChild(div);
            });
        }

        function saveInventory() {
            localStorage.setItem(INVENTORY_KEY, JSON.stringify(inventory));
            renderInventory();
        }

        document.getElementById('add-ingredient-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('ingredient-name').value;
            const qty = document.getElementById('ingredient-qty').value;
            const unit = document.getElementById('ingredient-unit').value;

            inventory.push({ name, qty, unit });
            saveInventory();
            
            document.getElementById('ingredient-name').value = '';
            document.getElementById('ingredient-qty').value = '1';
        });

        window.deleteItem = (index) => {
            if(confirm('Hapus bahan ini?')) {
                inventory.splice(index, 1);
                saveInventory();
            }
        };

        // --- 5. GEMINI API LOGIC (ONLINE ONLY) ---
        recipeBtn.addEventListener('click', async () => {
            if (!navigator.onLine) { alert("Perlu internet untuk mencari resep!"); return; }
            
            // CEK API KEY SEBELUM REQUEST
            if (!geminiApiKey) {
                openApiModal();
                alert("Mohon masukkan API Key Gemini terlebih dahulu.");
                return;
            }

            if (inventory.length === 0) { alert("Masukkan bahan dulu!"); return; }

            const outputDiv = document.getElementById('recipe-output');
            const outputText = document.getElementById('recipe-text');
            const spinner = document.getElementById('loading-spinner');
            const errorText = document.getElementById('suggestion-error');

            outputDiv.classList.add('hidden');
            errorText.classList.add('hidden');
            spinner.classList.remove('hidden');
            recipeBtn.disabled = true;

            const ingredientsStr = inventory.map(i => `${i.name} (${i.qty} ${i.unit})`).join(', ');
            const prompt = `Buatkan 1 resep masakan Indonesia menggunakan bahan: ${ingredientsStr}. Tambahkan bahan dasar (garam/minyak/air) jika perlu. Format: Judul, Bahan, Langkah.`;

            try {
                // Menggunakan variabel geminiApiKey yang dinamis
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${geminiApiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (response.status === 400 || response.status === 403) {
                     throw new Error("API Key tidak valid. Silakan periksa pengaturan.");
                }

                const data = await response.json();
                if (data.candidates && data.candidates[0].content) {
                    const text = data.candidates[0].content.parts[0].text;
                    // Format bold text menjadi strong dan newline menjadi br
                    outputText.innerHTML = text
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\n/g, '<br>');
                    outputDiv.classList.remove('hidden');
                } else {
                    throw new Error("Gagal mendapat respon AI");
                }
            } catch (err) {
                console.error(err);
                errorText.textContent = `Error: ${err.message}`;
                errorText.classList.remove('hidden');
                
                // Jika error karena key invalid, tawarkan untuk membuka modal
                if(err.message.includes("API Key")) {
                    setTimeout(() => openApiModal(), 1500);
                }
            } finally {
                spinner.classList.add('hidden');
                recipeBtn.disabled = false;
            }
        });

        // --- 6. DOWNLOAD FEATURE ---
        document.getElementById('download-recipe-btn').addEventListener('click', () => {
            const text = document.getElementById('recipe-text').innerText;
            if(!text) {
                alert("Belum ada resep untuk diunduh!");
                return;
            }
            
            // Buat file blob
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            // Buat link download sementara
            const a = document.createElement('a');
            a.href = url;
            // Nama file dengan tanggal
            const date = new Date().toISOString().slice(0, 10);
            a.download = `Resep_Dapur_Pintar_${date}.txt`;
            
            document.body.appendChild(a);
            a.click();
            
            // Bersihkan
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // Init
        renderInventory();
    </script>
</body>
</html>